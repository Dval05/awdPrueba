-- Converted from MySQL to PostgreSQL for Supabase/Render
-- Safe to run in Supabase SQL Editor

set search_path to public;

-- ============= ENUM TYPES =============
-- Helper to create enum if not exists
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'activity_status') THEN
    CREATE TYPE activity_status AS ENUM ('Planned','In Progress','Completed','Cancelled');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'media_type') THEN
    CREATE TYPE media_type AS ENUM ('Image','Video','Document');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'attendance_status') THEN
    CREATE TYPE attendance_status AS ENUM ('Present','Absent','Late','Excused','Sick');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'task_status') THEN
    CREATE TYPE task_status AS ENUM ('Pending','In Progress','Completed','Cancelled');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'task_priority') THEN
    CREATE TYPE task_priority AS ENUM ('Low','Medium','High','Urgent');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'invoice_type') THEN
    CREATE TYPE invoice_type AS ENUM ('Student','Teacher');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'invoice_status') THEN
    CREATE TYPE invoice_status AS ENUM ('Draft','Issued','Paid','Cancelled','Overdue');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'notification_type') THEN
    CREATE TYPE notification_type AS ENUM ('Message','Alert','Reminder','System');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'notification_priority') THEN
    CREATE TYPE notification_priority AS ENUM ('Low','Normal','High','Urgent');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'gender_type') THEN
    CREATE TYPE gender_type AS ENUM ('M','F','Other');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'service_type') THEN
    CREATE TYPE service_type AS ENUM ('Hourly','Monthly','Daily','Event');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'student_payment_method') THEN
    CREATE TYPE student_payment_method AS ENUM ('Cash','Credit Card','Debit Card','Transfer','Check','Other');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'student_payment_status') THEN
    CREATE TYPE student_payment_status AS ENUM ('Paid','Pending','Overdue','Partial','Cancelled');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'teacher_payment_method') THEN
    CREATE TYPE teacher_payment_method AS ENUM ('Cash','Transfer','Check','Other');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'teacher_payment_status') THEN
    CREATE TYPE teacher_payment_status AS ENUM ('Paid','Pending','Processing','Cancelled');
  END IF;
END $$;

-- ============= TABLES =============

CREATE TABLE IF NOT EXISTS activity (
  "ActivityID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "Name" varchar(200) NOT NULL,
  "Description" text,
  "GradeID" integer,
  "EmpID" integer,
  "ScheduledDate" date,
  "StartTime" time,
  "EndTime" time,
  "Location" varchar(200),
  "Category" varchar(50),
  "Status" activity_status DEFAULT 'Planned',
  "ImagePath" varchar(512),
  "CreatedBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS activity_media (
  "MediaID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "ActivityID" integer NOT NULL,
  "MediaType" media_type NOT NULL DEFAULT 'Image',
  "FilePath" varchar(512) NOT NULL,
  "FileSize" integer,
  "Caption" varchar(255),
  "UploadedBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS attendance (
  "AttendanceID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "StudentID" integer NOT NULL,
  "Date" date NOT NULL,
  "CheckInTime" time,
  "CheckOutTime" time,
  "Status" attendance_status NOT NULL DEFAULT 'Present',
  "IsLate" smallint DEFAULT 0,
  "LateMinutes" integer DEFAULT 0,
  "Notes" text,
  "CheckedInBy" integer,
  "CheckedOutBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS audit_log (
  "LogID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "UserID" integer,
  "Action" varchar(100) NOT NULL,
  "TableName" varchar(50),
  "RecordID" integer,
  "OldData" jsonb,
  "NewData" jsonb,
  "IPAddress" varchar(45),
  "UserAgent" varchar(255),
  "CreatedAt" timestamp NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS employee (
  "EmpID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "FirstName" varchar(50) NOT NULL,
  "LastName" varchar(50) NOT NULL,
  "DocumentNumber" varchar(20),
  "Position" varchar(100) NOT NULL,
  "Email" varchar(100),
  "PhoneNumber" varchar(20),
  "Address" varchar(255),
  "HireDate" date,
  "TerminationDate" date,
  "Salary" numeric(10,2),
  "BankAccount" varchar(50),
  "EmergencyContact" varchar(100),
  "EmergencyPhone" varchar(20),
  "Qualifications" text,
  "ProfilePicture" varchar(512),
  "IsActive" smallint NOT NULL DEFAULT 1,
  "UserID" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS employee_task (
  "TaskID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "EmpID" integer NOT NULL,
  "TaskName" varchar(200) NOT NULL,
  "Description" text,
  "DueDate" date,
  "Status" task_status DEFAULT 'Pending',
  "Priority" task_priority DEFAULT 'Medium',
  "CompletedDate" date,
  "CreatedBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS grade (
  "GradeID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "GradeName" varchar(100) NOT NULL,
  "Description" text,
  "AgeRangeMin" integer,
  "AgeRangeMax" integer,
  "MaxCapacity" integer,
  "IsActive" smallint NOT NULL DEFAULT 1,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS guardian (
  "GuardianID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "FirstName" varchar(50) NOT NULL,
  "LastName" varchar(50) NOT NULL,
  "DocumentNumber" varchar(20),
  "Relationship" varchar(50) NOT NULL,
  "PhoneNumber" varchar(20),
  "Email" varchar(100),
  "Address" varchar(255),
  "Occupation" varchar(100),
  "WorkPhone" varchar(20),
  "IsEmergencyContact" smallint DEFAULT 0,
  "IsAuthorizedPickup" smallint DEFAULT 1,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS invoice (
  "InvoiceID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "InvoiceNumber" varchar(50) NOT NULL UNIQUE,
  "InvoiceType" invoice_type NOT NULL DEFAULT 'Student',
  "ReferenceID" integer NOT NULL,
  "IssueDate" date NOT NULL,
  "DueDate" date,
  "TotalAmount" numeric(10,2) NOT NULL,
  "TaxAmount" numeric(10,2) DEFAULT 0,
  "DiscountAmount" numeric(10,2) DEFAULT 0,
  "FinalAmount" numeric(10,2) NOT NULL,
  "Description" text,
  "Status" invoice_status DEFAULT 'Draft',
  "FilePath" varchar(512),
  "CreatedBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS notification (
  "NotificationID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "SenderID" integer,
  "ReceiverID" integer NOT NULL,
  "Type" notification_type NOT NULL DEFAULT 'Message',
  "Priority" notification_priority DEFAULT 'Normal',
  "Subject" varchar(200),
  "Message" text NOT NULL,
  "IsRead" smallint DEFAULT 0,
  "ReadAt" timestamp,
  "RelatedModule" varchar(50),
  "RelatedID" integer,
  "ExpiresAt" timestamp,
  "CreatedAt" timestamp NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS permission (
  "PermissionID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "PermissionName" varchar(100) NOT NULL,
  "Module" varchar(50) NOT NULL,
  "Action" varchar(50) NOT NULL,
  "Description" text,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "Link" varchar(200),
  "Icon" varchar(50),
  CONSTRAINT unique_permission UNIQUE ("Module","Action")
);

CREATE TABLE IF NOT EXISTS role (
  "RoleID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "RoleName" varchar(50) NOT NULL UNIQUE,
  "Description" text,
  "IsActive" smallint NOT NULL DEFAULT 1,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS role_permission (
  "RolePermissionID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "RoleID" integer NOT NULL,
  "PermissionID" integer NOT NULL,
  "GrantedAt" timestamp NOT NULL DEFAULT now(),
  CONSTRAINT unique_role_permission UNIQUE ("RoleID","PermissionID")
);

CREATE TABLE IF NOT EXISTS session (
  "SessionID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "UserID" integer NOT NULL,
  "Token" varchar(255) NOT NULL UNIQUE,
  "IPAddress" varchar(45),
  "UserAgent" varchar(255),
  "ExpiresAt" timestamp NOT NULL,
  "CreatedAt" timestamp NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS student (
  "StudentID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "FirstName" varchar(50) NOT NULL,
  "LastName" varchar(50) NOT NULL,
  "BirthDate" date NOT NULL,
  "Gender" gender_type,
  "DocumentNumber" varchar(20),
  "Address" varchar(255),
  "Email" varchar(100),
  "PhoneNumber" varchar(20),
  "GradeID" integer,
  "ProfilePicture" varchar(512),
  "MedicalInfo" text,
  "EmergencyContact" varchar(100),
  "EmergencyPhone" varchar(20),
  "IsActive" smallint NOT NULL DEFAULT 1,
  "IsRecurrent" smallint NOT NULL DEFAULT 1,
  "EnrollmentDate" date,
  "WithdrawalDate" date,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS student_guardian (
  "StudentGuardianID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "StudentID" integer NOT NULL,
  "GuardianID" integer NOT NULL,
  "IsPrimary" smallint DEFAULT 0,
  "Priority" integer DEFAULT 1,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  CONSTRAINT unique_student_guardian UNIQUE ("StudentID","GuardianID")
);

CREATE TABLE IF NOT EXISTS student_observation (
  "ObservationID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "StudentID" integer NOT NULL,
  "EmpID" integer NOT NULL,
  "ObservationDate" date NOT NULL,
  "Category" varchar(50),
  "Observation" text NOT NULL,
  "IsPositive" smallint,
  "RequiresAction" smallint DEFAULT 0,
  "ActionTaken" text,
  "IsPrivate" smallint DEFAULT 0,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS student_payment (
  "StudentPaymentID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "StudentID" integer NOT NULL,
  "ServiceType" service_type NOT NULL DEFAULT 'Monthly',
  "Hours" numeric(5,2),
  "RatePerHour" numeric(10,2),
  "MonthlyFee" numeric(10,2),
  "DailyFee" numeric(10,2),
  "TotalAmount" numeric(10,2) NOT NULL,
  "PaidAmount" numeric(10,2) DEFAULT 0,
  "BalanceRemaining" numeric(10,2) DEFAULT 0,
  "PaymentDate" date,
  "DueDate" date NOT NULL,
  "PaymentMethod" student_payment_method,
  "Status" student_payment_status NOT NULL DEFAULT 'Pending',
  "IsRecurrent" smallint DEFAULT 1,
  "StartDate" date,
  "EndDate" date,
  "InvoiceNumber" varchar(50),
  "TransactionReference" varchar(100),
  "Notes" text,
  "ProcessedBy" integer,
  "CreatedBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS teacher_payment (
  "TeacherPaymentID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "EmpID" integer NOT NULL,
  "PaymentPeriod" varchar(20) NOT NULL,
  "PeriodStartDate" date NOT NULL,
  "PeriodEndDate" date NOT NULL,
  "BaseSalary" numeric(10,2) NOT NULL,
  "Bonuses" numeric(10,2) DEFAULT 0,
  "Overtime" numeric(10,2) DEFAULT 0,
  "Deductions" numeric(10,2) DEFAULT 0,
  "TotalAmount" numeric(10,2) NOT NULL,
  "PaymentDate" date NOT NULL,
  "PaymentMethod" teacher_payment_method NOT NULL DEFAULT 'Transfer',
  "Status" teacher_payment_status NOT NULL DEFAULT 'Pending',
  "TransactionReference" varchar(100),
  "Notes" text,
  "ProcessedBy" integer,
  "CreatedBy" integer,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS "user" (
  "UserID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "UserName" varchar(50) NOT NULL UNIQUE,
  "PasswordHash" varchar(255) NOT NULL,
  "Email" varchar(100) NOT NULL UNIQUE,
  "FirstName" varchar(50),
  "LastName" varchar(50),
  "Phone" varchar(20),
  "Address" varchar(255),
  "IsActive" smallint NOT NULL DEFAULT 1,
  "LastLogin" timestamp,
  "PasswordResetToken" varchar(255),
  "PasswordResetExpires" timestamp,
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UpdatedAt" timestamp NULL
);

CREATE TABLE IF NOT EXISTS user_role (
  "UserRoleID" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "UserID" integer NOT NULL,
  "RoleID" integer NOT NULL,
  "AssignedAt" timestamp NOT NULL DEFAULT now(),
  "AssignedBy" integer,
  CONSTRAINT unique_user_role UNIQUE ("UserID","RoleID")
);

-- ============= INDEXES =============
CREATE INDEX IF NOT EXISTS idx_activity_date ON activity ("ScheduledDate");
CREATE INDEX IF NOT EXISTS idx_activity_status ON activity ("Status");

CREATE INDEX IF NOT EXISTS idx_attendance_date ON attendance ("Date");
CREATE INDEX IF NOT EXISTS idx_attendance_status ON attendance ("Status");
CREATE INDEX IF NOT EXISTS idx_attendance_student_date ON attendance ("StudentID","Date");

CREATE INDEX IF NOT EXISTS idx_audit_action ON audit_log ("Action");
CREATE INDEX IF NOT EXISTS idx_audit_table ON audit_log ("TableName");
CREATE INDEX IF NOT EXISTS idx_audit_date ON audit_log ("CreatedAt");

CREATE INDEX IF NOT EXISTS idx_employee_name ON employee ("FirstName","LastName");
CREATE INDEX IF NOT EXISTS idx_employee_active ON employee ("IsActive");
CREATE INDEX IF NOT EXISTS idx_employee_document ON employee ("DocumentNumber");

CREATE INDEX IF NOT EXISTS idx_task_status ON employee_task ("Status");
CREATE INDEX IF NOT EXISTS idx_task_due_date ON employee_task ("DueDate");

CREATE INDEX IF NOT EXISTS idx_grade_active ON grade ("IsActive");

CREATE INDEX IF NOT EXISTS idx_guardian_name ON guardian ("FirstName","LastName");
CREATE INDEX IF NOT EXISTS idx_guardian_document ON guardian ("DocumentNumber");

CREATE INDEX IF NOT EXISTS idx_invoice_type ON invoice ("InvoiceType");
CREATE INDEX IF NOT EXISTS idx_invoice_reference ON invoice ("ReferenceID");
CREATE INDEX IF NOT EXISTS idx_invoice_status ON invoice ("Status");
CREATE INDEX IF NOT EXISTS idx_invoice_date ON invoice ("IssueDate");

CREATE INDEX IF NOT EXISTS idx_notification_read ON notification ("IsRead");
CREATE INDEX IF NOT EXISTS idx_notification_type ON notification ("Type");
CREATE INDEX IF NOT EXISTS idx_notification_receiver ON notification ("ReceiverID","IsRead");
CREATE INDEX IF NOT EXISTS idx_notification_receiver_unread ON notification ("ReceiverID","IsRead","CreatedAt");

CREATE INDEX IF NOT EXISTS idx_permission_module ON permission ("Module");

CREATE INDEX IF NOT EXISTS idx_session_expires ON session ("ExpiresAt");

CREATE INDEX IF NOT EXISTS idx_student_name ON student ("FirstName","LastName");
CREATE INDEX IF NOT EXISTS idx_student_active ON student ("IsActive");
CREATE INDEX IF NOT EXISTS idx_student_recurrent ON student ("IsRecurrent");
CREATE INDEX IF NOT EXISTS idx_student_document ON student ("DocumentNumber");

CREATE INDEX IF NOT EXISTS idx_student_guardian_guardian ON student_guardian ("GuardianID");

CREATE INDEX IF NOT EXISTS idx_observation_date ON student_observation ("ObservationDate");
CREATE INDEX IF NOT EXISTS idx_observation_category ON student_observation ("Category");

CREATE INDEX IF NOT EXISTS idx_student_payment_status ON student_payment ("Status");
CREATE INDEX IF NOT EXISTS idx_student_payment_date ON student_payment ("PaymentDate");
CREATE INDEX IF NOT EXISTS idx_student_payment_due_date ON student_payment ("DueDate");
CREATE INDEX IF NOT EXISTS idx_student_payment_service_type ON student_payment ("ServiceType");
CREATE INDEX IF NOT EXISTS idx_student_payment_invoice ON student_payment ("InvoiceNumber");
CREATE INDEX IF NOT EXISTS idx_student_payment_student_status ON student_payment ("StudentID","Status");
CREATE INDEX IF NOT EXISTS idx_student_payment_dates ON student_payment ("PaymentDate","DueDate");

CREATE INDEX IF NOT EXISTS idx_teacher_payment_status ON teacher_payment ("Status");
CREATE INDEX IF NOT EXISTS idx_teacher_payment_date ON teacher_payment ("PaymentDate");
CREATE INDEX IF NOT EXISTS idx_teacher_payment_period ON teacher_payment ("PaymentPeriod");
CREATE INDEX IF NOT EXISTS idx_teacher_payment_employee_period ON teacher_payment ("EmpID","PaymentPeriod");

CREATE INDEX IF NOT EXISTS idx_user_username ON "user" ("UserName");
CREATE INDEX IF NOT EXISTS idx_user_email ON "user" ("Email");
CREATE INDEX IF NOT EXISTS idx_user_active ON "user" ("IsActive");

CREATE INDEX IF NOT EXISTS idx_user_role_role ON user_role ("RoleID");
CREATE INDEX IF NOT EXISTS idx_user_role_assigned_by ON user_role ("AssignedBy");

-- ============= TRIGGERS =============
-- Generic updated_at trigger
CREATE OR REPLACE FUNCTION set_updated_at() RETURNS trigger AS $$
BEGIN
  NEW."UpdatedAt" := now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Attach to tables that have UpdatedAt
DO $$ BEGIN
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_activity';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_activity BEFORE UPDATE ON activity FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_attendance';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_attendance BEFORE UPDATE ON attendance FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_employee';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_employee BEFORE UPDATE ON employee FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_employee_task';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_employee_task BEFORE UPDATE ON employee_task FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_grade';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_grade BEFORE UPDATE ON grade FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_guardian';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_guardian BEFORE UPDATE ON guardian FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_invoice';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_invoice BEFORE UPDATE ON invoice FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_student';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_student BEFORE UPDATE ON student FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_student_observation';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_student_observation BEFORE UPDATE ON student_observation FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_student_payment';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_student_payment BEFORE UPDATE ON student_payment FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_teacher_payment';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_teacher_payment BEFORE UPDATE ON teacher_payment FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_set_updated_at_user';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_set_updated_at_user BEFORE UPDATE ON "user" FOR EACH ROW EXECUTE FUNCTION set_updated_at();
  END IF;
END $$;

-- Notification: auto-set ReadAt when IsRead flips from 0 to 1
CREATE OR REPLACE FUNCTION trg_mark_read_notification_fn() RETURNS trigger AS $$
BEGIN
  IF NEW."IsRead" = 1 AND OLD."IsRead" = 0 THEN
    NEW."ReadAt" := now();
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DO $$ BEGIN
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_mark_read_notification';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_mark_read_notification BEFORE UPDATE ON notification FOR EACH ROW EXECUTE FUNCTION trg_mark_read_notification_fn();
  END IF;
END $$;

-- Student payment: maintain balance and status
CREATE OR REPLACE FUNCTION trg_student_payment_balance_fn() RETURNS trigger AS $$
BEGIN
  NEW."BalanceRemaining" := coalesce(NEW."TotalAmount",0) - coalesce(NEW."PaidAmount",0);
  IF TG_OP = 'UPDATE' THEN
    IF NEW."BalanceRemaining" = 0 THEN
      NEW."Status" := 'Paid';
    ELSIF coalesce(NEW."PaidAmount",0) > 0 AND NEW."BalanceRemaining" > 0 THEN
      NEW."Status" := 'Partial';
    ELSIF NEW."DueDate" < current_date AND NEW."Status" <> 'Paid' THEN
      NEW."Status" := 'Overdue';
    END IF;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DO $$ BEGIN
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_student_payment_balance_insert';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_student_payment_balance_insert BEFORE INSERT ON student_payment FOR EACH ROW EXECUTE FUNCTION trg_student_payment_balance_fn();
  END IF;
  PERFORM 1 FROM pg_trigger WHERE tgname = 'trg_student_payment_balance_update';
  IF NOT FOUND THEN
    CREATE TRIGGER trg_student_payment_balance_update BEFORE UPDATE ON student_payment FOR EACH ROW EXECUTE FUNCTION trg_student_payment_balance_fn();
  END IF;
END $$;

-- ============= DATA INSERTS =============
-- activity
INSERT INTO activity ("ActivityID","Name","Description","GradeID","EmpID","ScheduledDate","StartTime","EndTime","Location","Category","Status","ImagePath","CreatedBy","CreatedAt","UpdatedAt") VALUES
(1,'Pintando con los dedos','Actividad sensorial para motricidad fina',1,3,'2025-11-17','08:00:00','09:00:00','',NULL,'Planned',NULL,2,'2025-11-06 15:00:00','2025-11-13 02:19:34'),
(2,'Explorando colores','Mezcla de colores con esponjas',2,2,NULL,'00:00:01','00:20:25',NULL,NULL,'Planned',NULL,3,'2025-11-06 15:05:00','2025-11-10 14:05:00'),
(3,'Aprendemos vocales','Canciones y tarjetas para reconocer vocales',3,4,NULL,'00:00:01','00:20:25',NULL,NULL,'Planned',NULL,4,'2025-11-06 15:10:00','2025-11-10 14:10:00'),
(4,'Juego con números','Contamos y clasificamos objetos',4,3,NULL,'00:00:01','00:20:25',NULL,NULL,'Planned',NULL,2,'2025-11-06 15:15:00','2025-11-10 14:15:00'),
(5,'Día de la familia','Padres participaron en actividades',4,1,NULL,'00:00:01','00:20:25',NULL,NULL,'Planned',NULL,1,'2025-11-06 15:20:00','2025-11-11 15:20:00'),
(6,'Fiesta de quito','Tradicioned',4,5,'2025-12-05','08:20:00','10:00:00','', 'Arte','Planned',NULL,NULL,'2025-11-13 02:20:12','2025-11-13 02:20:36'),
(7,'MiniOlimpiadas','Deportes',2,1,'2025-11-14','09:00:00','10:00:00','', 'Deporte','Planned',NULL,NULL,'2025-11-13 02:21:38','2025-11-13 03:06:18'),
(8,'Fiesta de Navidad','',1,1,'2025-12-23','10:00:00','12:00:00','', 'Otro','Planned',NULL,NULL,'2025-11-13 02:30:15','2025-11-13 13:40:29'),
(9,'Intercambio','',4,3,'2025-11-21','08:50:00','10:00:00','', 'Música','Completed',NULL,NULL,'2025-11-13 02:33:19','2025-11-13 03:06:50');

-- activity_media
INSERT INTO activity_media ("MediaID","ActivityID","MediaType","FilePath","FileSize","Caption","UploadedBy","CreatedAt") VALUES
(1,1,'Image','uploads/activities/fingerpaint1.jpg',245680,'Niños pintando con los dedos',2,'2025-11-07 17:00:00'),
(2,2,'Image','uploads/activities/colors1.jpg',312450,'Niños mezclando colores',3,'2025-11-08 17:10:00'),
(3,3,'Video','uploads/activities/vowels1.mp4',5678900,'Video vocales con canción',4,'2025-11-09 18:00:00');

-- attendance
INSERT INTO attendance ("AttendanceID","StudentID","Date","CheckInTime","CheckOutTime","Status","IsLate","LateMinutes","Notes","CheckedInBy","CheckedOutBy","CreatedAt","UpdatedAt") VALUES
(1,1,'2025-11-11','08:00:00','16:30:00','Present',0,0,NULL,2,2,'2025-11-11 13:00:00',NULL),
(2,2,'2025-11-11','08:15:00','16:45:00','Late',1,15,'Tráfico',3,3,'2025-11-11 13:15:00',NULL),
(3,3,'2025-11-11','08:05:00','16:35:00','Present',0,0,NULL,2,2,'2025-11-11 13:05:00',NULL),
(4,4,'2025-11-11','07:55:00','17:00:00','Present',0,0,NULL,3,3,'2025-11-11 12:55:00',NULL),
(5,5,'2025-11-11','08:10:00','16:40:00','Present',0,0,NULL,4,4,'2025-11-11 13:10:00',NULL);

-- employee
INSERT INTO employee ("EmpID","FirstName","LastName","DocumentNumber","Position","Email","PhoneNumber","Address","HireDate","TerminationDate","Salary","BankAccount","EmergencyContact","EmergencyPhone","Qualifications","ProfilePicture","IsActive","UserID","CreatedAt","UpdatedAt") VALUES
(1,'Patricia','Sánchez','1728394050','Directora Académica','patricia.sanchez@gmail.com','0987654321','Av. República E7-123','2020-03-01',NULL,1400.00,'Pichincha-4567890123','María Rodríguez','0998765432','Lic. en Educación Infantil, Magíster en Gestión Educativa','uploads/employees/patricia.jpg',1,2,'2025-11-05 14:00:00','2025-11-11 14:00:00'),
(2,'Carmen','Mendoza','1725567843','Docente Maternal','carmen.mendoza@gmail.com','0976543210','Av. 10 de Agosto N26-45','2021-04-01',NULL,980.00,'Guayaquil-7894561230','Luis Mendoza','0994433221','Lic. en Parvularia','uploads/employees/carmen.jpg',1,3,'2025-11-05 14:05:00','2025-11-10 13:45:00'),
(3,'Lucía','García','1712345678','Docente Inicial','lucia.garcia@gmail.com','0965432109','Av. Naciones Unidas N36-188','2021-06-10',NULL,1020.00,'Pichincha-1234567890','Carlos García','0996655443','Lic. en Educación Inicial','uploads/employees/lucia.jpg',1,4,'2025-11-05 14:10:00','2025-11-09 15:00:00'),
(4,'Ana','Martínez','1723456789','Docente Arte y Música','ana.martinez@gmail.com','0954321098','Av. Portugal E10-89','2022-01-15',NULL,1000.00,'Produbanco-9876543210','Marcos Martínez','0995566778','Lic. en Música Infantil, Certificado en Arte','uploads/employees/ana.jpg',1,5,'2025-11-05 14:15:00','2025-11-08 16:00:00'),
(5,'Diego','Torres','1719988776','Asistente Pedagógico','diego.torres@gmail.com','0998877665','Av. América N45-123','2023-04-10',NULL,750.00,'Pichincha-1122334455','Mónica Torres','0989988776','Bachiller en Ciencias, Curso auxiliar docente','uploads/employees/diego.jpg',1,6,'2025-11-05 14:20:00','2025-11-08 16:00:00');

-- employee_task
INSERT INTO employee_task ("TaskID","EmpID","TaskName","Description","DueDate","Status","Priority","CompletedDate","CreatedBy","CreatedAt","UpdatedAt") VALUES
(1,3,'Preparar materiales pintura','Reunir pinceles y vasos de agua','2025-11-06','Completed','High','2025-11-06',2,'2025-11-05 18:00:00','2025-11-06 19:00:00'),
(2,5,'Revisar asistencias','Verificar lista de asistencia diaria','2025-11-07','Pending','Medium',NULL,2,'2025-11-05 18:05:00','2025-11-07 14:00:00');

-- grade
INSERT INTO grade ("GradeID","GradeName","Description","AgeRangeMin","AgeRangeMax","MaxCapacity","IsActive","CreatedAt","UpdatedAt") VALUES
(1,'Maternal 1','Bebés 0-1',0,1,8,1,'2025-11-05 13:00:00','2025-11-11 13:00:00'),
(2,'Maternal 2','Niños 1-2',1,2,10,1,'2025-11-05 13:05:00','2025-11-11 13:05:00'),
(3,'Inicial 1','Niños 2-3',2,3,12,1,'2025-11-05 13:10:00','2025-11-11 13:10:00'),
(4,'Inicial 2','Niños 3-4',3,4,15,1,'2025-11-05 13:15:00','2025-11-11 13:15:00');

-- guardian
INSERT INTO guardian ("GuardianID","FirstName","LastName","DocumentNumber","Relationship","PhoneNumber","Email","Address","Occupation","WorkPhone","IsEmergencyContact","IsAuthorizedPickup","CreatedAt","UpdatedAt") VALUES
(1,'Gabriela','Smith','1729001111','Madre','0991122334','gabriela.smith@gmail.com','Calle El Sol 12','Contadora','022-345678',1,1,'2025-11-06 14:30:00','2025-11-11 17:00:00'),
(2,'Juan','Rodríguez','1712340001','Padre','0984455667','juan.rodriguez@gmail.com','Calle La Paz 45','Ingeniero','022-111222',1,1,'2025-11-06 14:35:00','2025-11-10 17:30:00'),
(3,'María','López','1720011111','Madre','0993344556','maria.lopez@gmail.com','Av. Simón Bolívar 90','Doctora','022-222333',1,1,'2025-11-06 14:40:00','2025-11-09 14:30:00'),
(4,'Ana','Rodríguez','1711112222','Madre','0982233445','ana.rodriguez@gmail.com','Calle Las Rosas 33','Diseñadora','022-333444',1,1,'2025-11-06 14:45:00','2025-11-08 19:00:00'),
(5,'Carlos','García','1722223333','Padre','0985566778','carlos.garcia@gmail.com','Av. Amazonas 120','Arquitecto','022-444555',1,1,'2025-11-06 14:50:00','2025-11-11 20:00:00'),
(6,'Sofía','Pérez','1723334444','Madre','0994455667','sofia.perez@gmail.com','Calle Primera 7','Abogada','022-555666',1,1,'2025-11-07 14:00:00','2025-11-10 21:00:00'),
(7,'Raúl','Vargas','1714445555','Padre','0989988776','raul.vargas@gmail.com','Calle Segunda 24','Empresario','022-666777',1,1,'2025-11-07 14:05:00','2025-11-09 23:00:00'),
(8,'María','Ruiz','1725556666','Madre','0995566777','maria.ruiz@gmail.com','Av. Siempre Viva 5','Administradora','022-777888',1,1,'2025-11-07 14:10:00','2025-11-08 23:30:00'),
(9,'José','Martínez','1716667777','Padre','0986677889','jose.martinez@gmail.com','Calle Tercera 40','Chef','022-888999',1,1,'2025-11-07 14:15:00','2025-11-09 00:00:00'),
(10,'Andrea','Valencia','1727778888','Madre','0992233445','andrea.valencia@gmail.com','Av. Reforma 22','Docente Universitaria','022-999000',1,1,'2025-11-07 14:20:00','2025-11-12 00:30:00');

-- invoice
INSERT INTO invoice ("InvoiceID","InvoiceNumber","InvoiceType","ReferenceID","IssueDate","DueDate","TotalAmount","TaxAmount","DiscountAmount","FinalAmount","Description","Status","FilePath","CreatedBy","CreatedAt","UpdatedAt") VALUES
(1,'INV-2025-001','Student',1,'2025-11-01','2025-11-05',350.00,0.00,0.00,350.00,'Pensión noviembre - Lucas','Paid','/invoices/INV-2025-001.pdf',2,'2025-11-05 17:10:00','2025-11-05 19:00:00'),
(2,'INV-2025-002','Student',2,'2025-11-01','2025-11-05',350.00,0.00,0.00,350.00,'Pensión noviembre - Sofía','Paid','/invoices/INV-2025-002.pdf',2,'2025-11-06 17:10:00','2025-11-06 19:00:00');

-- notification
INSERT INTO notification ("NotificationID","SenderID","ReceiverID","Type","Priority","Subject","Message","IsRead","ReadAt","RelatedModule","RelatedID","ExpiresAt","CreatedAt") VALUES
(1,1,2,'Alert','High','Nuevo pago registrado','El pago del alumno Lucas ha sido registrado',0,NULL,'payments',1,'2025-12-01 00:00:00','2025-11-05 17:20:00'),
(2,2,6,'Message','Normal','Actividad publicada','Se ha publicado la actividad Pintando con los dedos',1,'2025-11-06 13:00:00','activities',1,'2025-11-20 00:00:00','2025-11-06 17:30:00');

-- permission
INSERT INTO permission ("PermissionID","PermissionName","Module","Action","Description","CreatedAt","Link","Icon") VALUES
(1,'Ver panel principal','dashboard','view','Acceso al dashboard principal','2025-11-06 14:15:00','dashboard.html','fa-tachometer-alt'),
(2,'Gestión estudiantes','students','view','Listado y gestión de estudiantes','2025-11-06 14:16:00','students/students.html','fa-user-graduate'),
(3,'Gestión tutores','guardians','view','Listado y gestión de tutores','2025-11-06 14:17:00','guardians/parents.html','fa-users'),
(4,'Gestión empleados','staff','view','Listado y gestión de empleados','2025-11-06 14:18:00','staff/teachers.html','fa-chalkboard-teacher'),
(5,'Control asistencia','attendance','view','Registro de asistencia','2025-11-06 14:19:00','attendance/attendance.html','fa-calendar-check'),
(6,'Gestión actividades','activities','view','Gestión de actividades','2025-11-06 14:20:00','activities/activities.html','fa-calendar-alt'),
(7,'Gestión pagos','payments','view','Gestión de pagos','2025-11-06 14:21:00','payments/payments.html','fa-money-bill'),
(8,'Reportes','reports','view','Reportes generales','2025-11-06 14:22:00','reports/reports.html','fa-file-alt'),
(9,'Gestión usuarios','users','view','Gestión de usuarios y perfiles','2025-11-06 14:23:00','users/users-roles.html','fa-id-badge'),
(10,'Auditoría','audit','view','Acceso a logs de auditoría','2025-11-06 14:24:00','audit/audit-logs.html','fa-search'),
(11,'Observaciones','observations','view','Acceso a observaciones de estudiantes','2025-11-06 14:25:00','observations/observations.html','fa-clipboard'),
(12,'Facturación','invoices','view','Gestión de facturas','2025-11-06 14:26:00','invoices/invoices.html','fa-file-invoice'),
(13,'Notificaciones','communication','view','Enviar/leer notificaciones','2025-11-06 14:27:00','communication/communication.html','fa-comments'),
(14,'Pagos de alumnos','payments','view_student','Pagos de alumnos','2025-11-06 14:28:00','payments/student-payments.html','fa-image'),
(15,'Pagos docentes','payments','view_teacher','Pagos a personal docente','2025-11-06 14:29:00','payments/teacher-payments.html','fa-coins'),
(16,'Gestion de roles','users','manage','Perfil, roles y permisos','2025-11-06 14:30:00','users/role-permissions.html','fa-clock');

-- role
INSERT INTO role ("RoleID","RoleName","Description","IsActive","CreatedAt","UpdatedAt") VALUES
(1,'Director','Administrador general',1,'2025-11-06 14:00:00','2025-11-11 15:00:00'),
(2,'Teacher','Docente',1,'2025-11-06 14:05:00','2025-11-11 15:05:00'),
(3,'Parent','Padre/Tutor',1,'2025-11-06 14:10:00','2025-11-11 15:10:00');

-- role_permission
INSERT INTO role_permission ("RolePermissionID","RoleID","PermissionID","GrantedAt") VALUES
(190,1,1,'2025-11-06 14:40:00'),(191,1,2,'2025-11-06 14:40:00'),(192,1,3,'2025-11-06 14:40:00'),(193,1,4,'2025-11-06 14:40:00'),(194,1,5,'2025-11-06 14:40:00'),(195,1,6,'2025-11-06 14:40:00'),(196,1,7,'2025-11-06 14:40:00'),(197,1,8,'2025-11-06 14:40:00'),(198,1,9,'2025-11-06 14:40:00'),(199,1,10,'2025-11-06 14:40:00'),(200,1,11,'2025-11-06 14:40:00'),(201,1,12,'2025-11-06 14:40:00'),(202,1,13,'2025-11-06 14:40:00'),(203,1,14,'2025-11-06 14:40:00'),(204,1,15,'2025-11-06 14:40:00'),(205,1,16,'2025-11-06 14:40:00'),(206,2,1,'2025-11-06 14:41:00'),(207,2,2,'2025-11-06 14:41:00'),(208,2,5,'2025-11-06 14:41:00'),(209,2,6,'2025-11-06 14:41:00'),(210,2,11,'2025-11-06 14:41:00'),(211,2,14,'2025-11-06 14:41:00'),(212,3,1,'2025-11-06 14:42:00'),(213,3,2,'2025-11-06 14:42:00'),(214,3,3,'2025-11-06 14:42:00'),(215,3,6,'2025-11-06 14:42:00'),(216,3,13,'2025-11-06 14:42:00');

-- session
INSERT INTO session ("SessionID","UserID","Token","IPAddress","UserAgent","ExpiresAt","CreatedAt") VALUES
(1,1,'sess_admin_abc123','192.168.1.10','Mozilla/5.0 (Windows NT 10.0)','2025-11-13 09:00:00','2025-11-11 14:00:00'),
(2,2,'sess_pat_456def','192.168.1.11','Mozilla/5.0 (Macintosh)','2025-11-13 10:00:00','2025-11-10 13:30:00'),
(3,1,'f1865590f1d06c01595c6266397e1bfbea9a8358abe484074a4f97881be71f0d','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 04:05:10','2025-11-12 09:05:10'),
(4,1,'078209874ceeaa956a9dfc8e120ac1199efc060689993e97be5f8491221379b6','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 07:12:47','2025-11-12 12:12:47'),
(5,1,'9514722f5cf23b04ece62739963c3b51fc26b7bfd9d91e9978f7941536be73fa','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 09:05:44','2025-11-12 14:05:44'),
(6,1,'e43611e6985ad14ef466822bcbcb2be70258b8716f6ea33538867d1e47159dc7','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 11:15:28','2025-11-12 16:15:28'),
(7,9,'dd25c885c341b13d9b1c67ad675a9de77afbeef7fac140143eddacb9d8d35daa','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 19:04:16','2025-11-13 00:04:16'),
(8,1,'b8aa50c43c6e48bf9bf2a61aae3214c2d954573a4183253acf498e31021feb6d','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 19:31:43','2025-11-13 00:31:43'),
(9,1,'884afa609c88e1fcfb912b7ddd73cc9294e5629ce41387be35c362ed6db0eb44','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-19 20:25:06','2025-11-13 01:25:06'),
(10,1,'c4e98e0cd648a0629e66bf84ec3b3d1403c4a05ef2bfc5c719e6e384da61280a','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-20 08:20:33','2025-11-13 13:20:33'),
(11,1,'d2d2c2d63c16e28a9f204062e8b710fd2a609655e3bbba7e55ed85d0f2cafaa9','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-20 08:26:20','2025-11-13 13:26:20'),
(12,1,'e5c7f33059474a717a25d5d61824cf2b54772c4b0133f835baf61ed629ad613d','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-20 08:29:51','2025-11-13 13:29:51'),
(13,1,'fb5f8bc0962004e55091d13029537a321386c16cf00f9fa82ee45685e4698c25','::1','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36','2025-11-20 08:31:40','2025-11-13 13:31:40');

-- student
INSERT INTO student ("StudentID","FirstName","LastName","BirthDate","Gender","DocumentNumber","Address","Email","PhoneNumber","GradeID","ProfilePicture","MedicalInfo","EmergencyContact","EmergencyPhone","IsActive","IsRecurrent","EnrollmentDate","WithdrawalDate","CreatedAt","UpdatedAt") VALUES
(1,'Lucas','Vásquez','2021-05-20','M','0911111111','Av. Cipreses N45-67','lucas.vasquez@gmail.com','0997001111',1,'profiles/lucas.jpg','Alergia leve a la leche','Gabriela Smith','0991122334',1,1,'2024-01-05',NULL,'2025-11-06 13:00:00','2025-11-11 13:00:00'),
(2,'Sofía','López','2020-08-15','F','0912222222','Av. González Suárez N27-142','sofia.lopez@gmail.com','0997002222',2,'profiles/sofia.jpg','Ninguna','Juan Rodríguez','0984455667',1,1,'2023-09-10',NULL,'2025-11-06 13:05:00','2025-11-11 13:05:00'),
(3,'Martín','Morales','2020-06-30','M','0913333333','Calle Japón E7-119','martin.morales@gmail.com','0997003333',2,'profiles/martin.jpg','Usa inhalador','María López','0993344556',1,1,'2023-08-20',NULL,'2025-11-06 13:10:00','2025-11-10 13:45:00'),
(4,'Camila','Herrera','2019-09-10','F','0914444444','Av. Mariana de Jesús E7-45','camila.herrera@gmail.com','0997004444',3,'profiles/camila.jpg','Control médico semestral','Ana Rodríguez','0982233445',1,1,'2022-07-15',NULL,'2025-11-06 13:15:00','2025-11-09 15:00:00'),
(5,'Valentina','Pérez','2019-10-25','F','0915555555','Calle Francisco Salazar E4-56','valentina.perez@gmail.com','0997005555',3,'profiles/valentina.jpg','Ninguna','Carlos García','0985566778',1,1,'2022-07-20',NULL,'2025-11-06 13:20:00','2025-11-11 20:00:00'),
(6,'Emilia','Castro','2019-03-17','F','0916666666','Av. De los Shyris N35-234','emilia.castro@gmail.com','0997006666',4,'profiles/emilia.jpg','Ninguna','Sofía Pérez','0994455667',1,1,'2022-03-10',NULL,'2025-11-06 13:25:00','2025-11-10 21:00:00'),
(7,'Matías','Ruiz','2019-04-02','M','0917777777','Calle Luis Cordero E6-78','matias.ruiz@gmail.com','0997007777',4,'profiles/matias.jpg','Alergia al polvo','Raúl Vargas','0989988776',1,1,'2022-03-20',NULL,'2025-11-06 13:30:00','2025-11-09 23:00:00'),
(8,'Renata','Ávila','2020-02-10','F','0918888888','Av. Occidental N25-67','renata.avila@gmail.com','0997008888',2,'profiles/renata.jpg','Ninguna','María Ruiz','0995566777',1,1,'2023-05-05',NULL,'2025-11-06 13:35:00','2025-11-08 23:30:00'),
(9,'Santiago','Santana','2019-01-28','M','0919999999','Calle Diego de Almagro N32-89','santiago.santana@gmail.com','0997009999',4,'profiles/santiago.jpg','Alergia al maní','José Martínez','0986677889',1,1,'2021-11-01',NULL,'2025-11-06 13:40:00','2025-11-09 00:00:00'),
(10,'Isabela','Paredes','2020-07-22','F','0910000001','Av. Naciones Unidas E10-23','isabela.paredes@gmail.com','0997010001',2,'profiles/isabela.jpg','Ninguna','Andrea Valencia','0992233445',1,1,'2023-06-10',NULL,'2025-11-06 13:45:00','2025-11-12 00:30:00'),
(11,'Thiago','Jiménez','2020-05-05','M','0910000002','Av. Brasil N50-12','thiago.jimenez@gmail.com','0997010002',3,'profiles/thiago.jpg','Alergia a la penicilina','Gabriela Smith','0991122334',1,1,'2023-07-01',NULL,'2025-11-06 13:50:00','2025-11-11 17:00:00'),
(12,'Victoria','Romero','2019-12-01','F','0910000003','Av. República del Salvador N45-60','victoria.romero@gmail.com','0997010003',3,'profiles/victoria.jpg','Ninguna','Juan Rodríguez','0984455667',1,1,'2022-02-20',NULL,'2025-11-06 13:55:00','2025-11-10 17:30:00'),
(13,'Sebastián','Cárdenas','2021-02-14','M','0910000004','Calle Eloy Alfaro N28-88','sebastian.cardenas@gmail.com','0997010004',1,'profiles/sebastian.jpg','Reflujo controlado','María López','0993344556',1,1,'2024-09-01',NULL,'2025-11-06 14:00:00','2025-11-10 13:45:00'),
(14,'Emma','Paredes','2021-06-08','F','0910000005','Calle América N24-56','emma.paredes@gmail.com','0997010005',1,'profiles/emma.jpg','Ninguna','Ana Rodríguez','0982233445',1,1,'2024-09-10',NULL,'2025-11-06 14:05:00','2025-11-08 19:00:00'),
(15,'Samuel','Martínez','2020-03-12','M','0910000006','Av. Amazonas N33-100','samuel.martinez@gmail.com','0997010006',2,'profiles/samuel.jpg','Alergia al polen','Carlos García','0985566778',1,1,'2023-03-05',NULL,'2025-11-06 14:10:00','2025-11-11 20:00:00');

-- student_guardian
INSERT INTO student_guardian ("StudentGuardianID","StudentID","GuardianID","IsPrimary","Priority","CreatedAt") VALUES
(1,1,1,1,1,'2025-11-06 14:15:00'),(2,1,2,0,2,'2025-11-06 14:16:00'),(3,2,2,1,1,'2025-11-06 14:17:00'),(4,3,3,1,1,'2025-11-06 14:18:00'),(5,4,4,1,1,'2025-11-06 14:19:00'),(6,5,5,1,1,'2025-11-06 14:20:00'),(7,6,6,1,1,'2025-11-06 14:21:00'),(8,7,7,1,1,'2025-11-06 14:22:00'),(9,8,8,1,1,'2025-11-06 14:23:00'),(10,9,9,1,1,'2025-11-06 14:24:00'),(11,10,10,1,1,'2025-11-06 14:25:00'),(12,11,1,1,1,'2025-11-06 14:26:00'),(13,12,2,1,1,'2025-11-06 14:27:00'),(14,13,3,1,1,'2025-11-06 14:28:00'),(15,14,4,1,1,'2025-11-06 14:29:00'),(16,15,5,1,1,'2025-11-06 14:30:00');

-- student_observation
INSERT INTO student_observation ("ObservationID","StudentID","EmpID","ObservationDate","Category","Observation","IsPositive","RequiresAction","ActionTaken","IsPrivate","CreatedAt","UpdatedAt") VALUES
(1,1,3,'2025-11-08','Comportamiento','Lucas compartió sus juguetes con los compañeros',1,0,NULL,0,'2025-11-08 19:30:00',NULL),
(2,2,2,'2025-11-07','Aprendizaje','Sofía muestra avance en reconocimiento de colores',1,0,NULL,0,'2025-11-07 20:00:00',NULL),
(3,7,2,'2025-11-10','Salud','Matías presentó irritación en la piel',NULL,1,'Se informó a los padres y se aplicó protocolo',1,'2025-11-10 18:00:00','2025-11-13 05:01:37'),
(4,6,3,'2025-11-07','Salud','Presento Fiebre',NULL,0,NULL,0,'2025-11-13 05:10:49',NULL);

-- student_payment
INSERT INTO student_payment ("StudentPaymentID","StudentID","ServiceType","Hours","RatePerHour","MonthlyFee","DailyFee","TotalAmount","PaidAmount","BalanceRemaining","PaymentDate","DueDate","PaymentMethod","Status","IsRecurrent","StartDate","EndDate","InvoiceNumber","TransactionReference","Notes","ProcessedBy","CreatedBy","CreatedAt","UpdatedAt") VALUES
(1,1,'Monthly',NULL,NULL,350.00,NULL,350.00,350.00,0.00,'2025-11-01','2025-11-05','Transfer','Paid',1,'2025-11-01','2025-11-30','INV-2025-001','TRANS-001-2025','Pago noviembre',2,1,'2025-11-05 16:00:00','2025-11-05 19:00:00'),
(2,2,'Monthly',NULL,NULL,350.00,NULL,350.00,350.00,0.00,'2025-11-02','2025-11-05','Transfer','Paid',1,'2025-11-01','2025-11-30','INV-2025-002','TRANS-002-2025','Pago noviembre',2,1,'2025-11-06 16:00:00','2025-11-06 19:00:00'),
(3,3,'Monthly',NULL,NULL,350.00,NULL,350.00,175.00,175.00,'2025-11-03','2025-11-05','Cash','Partial',1,'2025-11-01','2025-11-30','INV-2025-003',NULL,'Pago parcial',3,1,'2025-11-07 16:00:00','2025-11-07 19:00:00'),
(4,4,'Monthly',NULL,NULL,350.00,NULL,350.00,350.00,0.00,'2025-11-01','2025-11-05','Debit Card','Paid',1,'2025-11-01','2025-11-30','INV-2025-004','TRANS-004-2025','Pago noviembre',4,1,'2025-11-08 16:00:00','2025-11-08 20:00:00'),
(5,5,'Monthly',NULL,NULL,350.00,NULL,350.00,350.00,0.00,'2025-11-01','2025-11-05','Transfer','Paid',1,'2025-11-01','2025-11-30','INV-2025-005','TRANS-005-2025','Pago noviembre',2,1,'2025-11-09 16:00:00','2025-11-09 19:00:00');

-- teacher_payment
INSERT INTO teacher_payment ("TeacherPaymentID","EmpID","PaymentPeriod","PeriodStartDate","PeriodEndDate","BaseSalary","Bonuses","Overtime","Deductions","TotalAmount","PaymentDate","PaymentMethod","Status","TransactionReference","Notes","ProcessedBy","CreatedBy","CreatedAt","UpdatedAt") VALUES
(1,1,'2025-10','2025-10-01','2025-10-31',1400.00,200.00,0.00,150.00,1450.00,'2025-11-05','Transfer','Paid','PAY-DIR-001-2025','Pago octubre con bono',1,1,'2025-11-05 17:00:00','2025-11-05 19:00:00'),
(2,2,'2025-10','2025-10-01','2025-10-31',980.00,50.00,0.00,90.00,940.00,'2025-11-05','Transfer','Paid','PAY-TCH-002-2025','Pago octubre',1,1,'2025-11-06 17:00:00','2025-11-06 19:00:00'),
(3,3,'2025-10','2025-10-01','2025-10-31',1020.00,0.00,0.00,96.30,923.70,'2025-11-05','Transfer','Paid','PAY-TCH-003-2025','Pago octubre',1,1,'2025-11-07 17:00:00','2025-11-07 19:00:00');

-- user
INSERT INTO "user" ("UserID","UserName","PasswordHash","Email","FirstName","LastName","Phone","Address","IsActive","LastLogin","PasswordResetToken","PasswordResetExpires","CreatedAt","UpdatedAt") VALUES
(1,'admin','$2y$10$RB3GHK0tnk3XOBhlgYgpx.osqFJVAGTjvvdIVe.edey3Vlv3DbOOu','admin.nicekids@gmail.com','María','Rodríguez','0998765432','Av. 6 de Diciembre N34-120',1,'2025-11-13 08:31:40',NULL,NULL,'2025-11-05 14:00:00','2025-11-13 13:31:40'),
(2,'psanchez','hash_pat_2','patricia.sanchez@gmail.com','Patricia','Sánchez','0987654321','Av. República E7-123',1,'2025-11-10 08:30:00',NULL,NULL,'2025-11-06 14:00:00','2025-11-10 13:30:00'),
(3,'cmendoza','hash_car_3','carmen.mendoza@gmail.com','Carmen','Mendoza','0976543210','Av. 10 de Agosto N26-45',1,'2025-11-09 08:45:00',NULL,NULL,'2025-11-06 14:05:00','2025-11-09 13:45:00'),
(4,'lgarcia','hash_luc_4','lucia.garcia@gmail.com','Lucía','García','0965432109','Av. Naciones Unidas N36-188',1,'2025-11-09 10:00:00',NULL,NULL,'2025-11-06 14:10:00','2025-11-09 15:00:00'),
(5,'atorres','hash_diego_5','diego.torres@gmail.com','Diego','Torres','0998877665','Av. América N45-123',1,'2025-11-08 11:00:00',NULL,NULL,'2025-11-06 14:15:00','2025-11-08 16:00:00'),
(6,'gsmith','hash_gs_6','gabriela.smith@gmail.com','Gabriela','Smith','0991122334','Calle El Sol 12',1,'2025-11-11 12:00:00',NULL,NULL,'2025-11-07 14:00:00','2025-11-11 17:00:00'),
(7,'jrodriguez','hash_jr_7','juan.rodriguez@gmail.com','Juan','Rodríguez','0984455667','Calle La Paz 45',1,'2025-11-10 12:30:00',NULL,NULL,'2025-11-07 14:05:00','2025-11-10 17:30:00'),
(8,'mlopez','hash_ml_8','maria.lopez@gmail.com','María','López','0993344556','Av. Simón Bolívar 90',1,'2025-11-09 09:30:00',NULL,NULL,'2025-11-07 14:10:00','2025-11-09 14:30:00'),
(9,'arodriguez','$2y$10$RB3GHK0tnk3XOBhlgYgpx.osqFJVAGTjvvdIVe.edey3Vlv3DbOOu','ana.rodriguez@gmail.com','Ana','Rodríguez','0982233445','Calle Las Rosas 33',1,'2025-11-12 19:04:16',NULL,NULL,'2025-11-07 14:15:00','2025-11-13 00:04:16'),
(10,'cgarcia','hash_cg_10','carlos.garcia@gmail.com','Carlos','García','0985566778','Av. Amazonas 120',1,'2025-11-11 15:00:00',NULL,NULL,'2025-11-07 14:20:00','2025-11-11 20:00:00'),
(11,'sanchezp','hash_sp_11','sofia.perez@gmail.com','Sofía','Pérez','0994455667','Calle Primera 7',1,'2025-11-10 16:00:00',NULL,NULL,'2025-11-07 14:25:00','2025-11-10 21:00:00'),
(12,'rvargas','hash_rv_12','raul.vargas@gmail.com','Raúl','Vargas','0989988776','Calle Segunda 24',1,'2025-11-09 18:00:00',NULL,NULL,'2025-11-07 14:30:00','2025-11-09 23:00:00'),
(13,'mruiz','hash_mr_13','maria.ruiz@gmail.com','María','Ruiz','0995566777','Av. Siempre Viva 5',1,'2025-11-08 18:30:00',NULL,NULL,'2025-11-07 14:35:00','2025-11-08 23:30:00'),
(14,'jmartinez','hash_jm_14','jose.martinez@gmail.com','José','Martínez','0986677889','Calle Tercera 40',1,'2025-11-08 19:00:00',NULL,NULL,'2025-11-07 14:40:00','2025-11-09 00:00:00'),
(15,'avalencia','$2y$10$RB3GHK0tnk3XOBhlgYgpx.osqFJVAGTjvvdIVe.edey3Vlv3DbOOu','andrea.valencia@gmail.com','Andrea','Valencia','0992233445','Av. Reforma 22',1,'2025-11-11 19:30:00',NULL,NULL,'2025-11-07 14:45:00','2025-11-12 09:04:32'),
(16,'cvasquez','hash_cv_16','carlos.vasquez@gmail.com','Carlos','Vásquez','0982345678','Calle Verde 8',1,'2025-11-10 20:00:00',NULL,NULL,'2025-11-07 14:50:00','2025-11-11 01:00:00'),
(17,'dlopez','hash_dl_17','diego.lopez@gmail.com','Diego','López','0984567890','Av. Central 77',1,'2025-11-09 21:15:00',NULL,NULL,'2025-11-07 14:55:00','2025-11-10 02:15:00'),
(18,'ncastro','hash_nc_18','natalia.castro@gmail.com','Natalia','Castro','0999012345','Calle Nueva 12',1,'2025-11-11 21:00:00',NULL,NULL,'2025-11-07 15:00:00','2025-11-12 02:00:00'),
(19,'gsantos','hash_gs_19','gabriela.santos@gmail.com','Gabriela','Santos','0990123456','Av. Los Rios 99',1,'2025-11-11 21:30:00',NULL,NULL,'2025-11-07 15:05:00','2025-11-12 02:30:00');

-- user_role
INSERT INTO user_role ("UserRoleID","UserID","RoleID","AssignedAt","AssignedBy") VALUES
(1,1,1,'2025-11-05 14:05:00',1),(2,2,2,'2025-11-06 14:10:00',1),(3,3,2,'2025-11-06 14:11:00',1),(4,4,2,'2025-11-06 14:12:00',1),(5,5,2,'2025-11-06 14:13:00',1),(6,6,3,'2025-11-07 15:00:00',1),(7,7,3,'2025-11-07 15:05:00',1),(8,8,3,'2025-11-07 15:10:00',1),(9,9,3,'2025-11-07 15:15:00',1),(10,10,3,'2025-11-07 15:20:00',1),(11,11,3,'2025-11-07 15:25:00',1),(12,12,3,'2025-11-07 15:30:00',1),(13,13,3,'2025-11-07 15:35:00',1),(14,14,3,'2025-11-07 15:40:00',1),(15,15,3,'2025-11-07 15:45:00',1),(16,16,3,'2025-11-07 15:50:00',1),(17,17,3,'2025-11-07 15:55:00',1),(18,18,3,'2025-11-07 16:00:00',1),(19,19,3,'2025-11-07 16:05:00',1);

-- ============= FOREIGN KEYS =============
-- Pospuesto hasta después de los datos para evitar violaciones durante seed
-- Use DO blocks to crear constraints solo si faltan (Postgres/Supabase)
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_activity_created_by') THEN
    ALTER TABLE activity ADD CONSTRAINT fk_activity_created_by FOREIGN KEY ("CreatedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_activity_employee') THEN
    ALTER TABLE activity ADD CONSTRAINT fk_activity_employee FOREIGN KEY ("EmpID") REFERENCES employee ("EmpID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_activity_grade') THEN
    ALTER TABLE activity ADD CONSTRAINT fk_activity_grade FOREIGN KEY ("GradeID") REFERENCES grade ("GradeID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_activity_media_activity') THEN
    ALTER TABLE activity_media ADD CONSTRAINT fk_activity_media_activity FOREIGN KEY ("ActivityID") REFERENCES activity ("ActivityID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_activity_media_uploaded_by') THEN
    ALTER TABLE activity_media ADD CONSTRAINT fk_activity_media_uploaded_by FOREIGN KEY ("UploadedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_attendance_checked_in_by') THEN
    ALTER TABLE attendance ADD CONSTRAINT fk_attendance_checked_in_by FOREIGN KEY ("CheckedInBy") REFERENCES employee ("EmpID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_attendance_checked_out_by') THEN
    ALTER TABLE attendance ADD CONSTRAINT fk_attendance_checked_out_by FOREIGN KEY ("CheckedOutBy") REFERENCES employee ("EmpID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_attendance_student') THEN
    ALTER TABLE attendance ADD CONSTRAINT fk_attendance_student FOREIGN KEY ("StudentID") REFERENCES student ("StudentID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_audit_log_user') THEN
    ALTER TABLE audit_log ADD CONSTRAINT fk_audit_log_user FOREIGN KEY ("UserID") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_employee_user') THEN
    ALTER TABLE employee ADD CONSTRAINT fk_employee_user FOREIGN KEY ("UserID") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_employee_task_created_by') THEN
    ALTER TABLE employee_task ADD CONSTRAINT fk_employee_task_created_by FOREIGN KEY ("CreatedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_employee_task_employee') THEN
    ALTER TABLE employee_task ADD CONSTRAINT fk_employee_task_employee FOREIGN KEY ("EmpID") REFERENCES employee ("EmpID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_invoice_created_by') THEN
    ALTER TABLE invoice ADD CONSTRAINT fk_invoice_created_by FOREIGN KEY ("CreatedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_notification_receiver') THEN
    ALTER TABLE notification ADD CONSTRAINT fk_notification_receiver FOREIGN KEY ("ReceiverID") REFERENCES "user" ("UserID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_notification_sender') THEN
    ALTER TABLE notification ADD CONSTRAINT fk_notification_sender FOREIGN KEY ("SenderID") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_role_permission_permission') THEN
    ALTER TABLE role_permission ADD CONSTRAINT fk_role_permission_permission FOREIGN KEY ("PermissionID") REFERENCES permission ("PermissionID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_role_permission_role') THEN
    ALTER TABLE role_permission ADD CONSTRAINT fk_role_permission_role FOREIGN KEY ("RoleID") REFERENCES role ("RoleID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_session_user') THEN
    ALTER TABLE session ADD CONSTRAINT fk_session_user FOREIGN KEY ("UserID") REFERENCES "user" ("UserID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_student_grade') THEN
    ALTER TABLE student ADD CONSTRAINT fk_student_grade FOREIGN KEY ("GradeID") REFERENCES grade ("GradeID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_student_guardian_guardian') THEN
    ALTER TABLE student_guardian ADD CONSTRAINT fk_student_guardian_guardian FOREIGN KEY ("GuardianID") REFERENCES guardian ("GuardianID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_student_guardian_student') THEN
    ALTER TABLE student_guardian ADD CONSTRAINT fk_student_guardian_student FOREIGN KEY ("StudentID") REFERENCES student ("StudentID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_observation_employee') THEN
    ALTER TABLE student_observation ADD CONSTRAINT fk_observation_employee FOREIGN KEY ("EmpID") REFERENCES employee ("EmpID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_observation_student') THEN
    ALTER TABLE student_observation ADD CONSTRAINT fk_observation_student FOREIGN KEY ("StudentID") REFERENCES student ("StudentID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_student_payment_created_by') THEN
    ALTER TABLE student_payment ADD CONSTRAINT fk_student_payment_created_by FOREIGN KEY ("CreatedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_student_payment_processed_by') THEN
    ALTER TABLE student_payment ADD CONSTRAINT fk_student_payment_processed_by FOREIGN KEY ("ProcessedBy") REFERENCES employee ("EmpID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_student_payment_student') THEN
    ALTER TABLE student_payment ADD CONSTRAINT fk_student_payment_student FOREIGN KEY ("StudentID") REFERENCES student ("StudentID") ON DELETE CASCADE;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_teacher_payment_created_by') THEN
    ALTER TABLE teacher_payment ADD CONSTRAINT fk_teacher_payment_created_by FOREIGN KEY ("CreatedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_teacher_payment_employee') THEN
    ALTER TABLE teacher_payment ADD CONSTRAINT fk_teacher_payment_employee FOREIGN KEY ("EmpID") REFERENCES employee ("EmpID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_teacher_payment_processed_by') THEN
    ALTER TABLE teacher_payment ADD CONSTRAINT fk_teacher_payment_processed_by FOREIGN KEY ("ProcessedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
END $$;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_user_role_assigned_by') THEN
    ALTER TABLE user_role ADD CONSTRAINT fk_user_role_assigned_by FOREIGN KEY ("AssignedBy") REFERENCES "user" ("UserID") ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_user_role_role') THEN
    ALTER TABLE user_role ADD CONSTRAINT fk_user_role_role FOREIGN KEY ("RoleID") REFERENCES role ("RoleID") ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_user_role_user') THEN
    ALTER TABLE user_role ADD CONSTRAINT fk_user_role_user FOREIGN KEY ("UserID") REFERENCES "user" ("UserID") ON DELETE CASCADE;
  END IF;
END $$;

-- ============= SEQUENCES FIX =============
-- Ensure identity sequences are set after manual ID inserts
SELECT setval(pg_get_serial_sequence('activity','ActivityID'), COALESCE((SELECT MAX("ActivityID") FROM activity),1));
SELECT setval(pg_get_serial_sequence('activity_media','MediaID'), COALESCE((SELECT MAX("MediaID") FROM activity_media),1));
SELECT setval(pg_get_serial_sequence('attendance','AttendanceID'), COALESCE((SELECT MAX("AttendanceID") FROM attendance),1));
SELECT setval(pg_get_serial_sequence('audit_log','LogID'), COALESCE((SELECT MAX("LogID") FROM audit_log),1));
SELECT setval(pg_get_serial_sequence('employee','EmpID'), COALESCE((SELECT MAX("EmpID") FROM employee),1));
SELECT setval(pg_get_serial_sequence('employee_task','TaskID'), COALESCE((SELECT MAX("TaskID") FROM employee_task),1));
SELECT setval(pg_get_serial_sequence('grade','GradeID'), COALESCE((SELECT MAX("GradeID") FROM grade),1));
SELECT setval(pg_get_serial_sequence('guardian','GuardianID'), COALESCE((SELECT MAX("GuardianID") FROM guardian),1));
SELECT setval(pg_get_serial_sequence('invoice','InvoiceID'), COALESCE((SELECT MAX("InvoiceID") FROM invoice),1));
SELECT setval(pg_get_serial_sequence('notification','NotificationID'), COALESCE((SELECT MAX("NotificationID") FROM notification),1));
SELECT setval(pg_get_serial_sequence('permission','PermissionID'), COALESCE((SELECT MAX("PermissionID") FROM permission),1));
SELECT setval(pg_get_serial_sequence('role','RoleID'), COALESCE((SELECT MAX("RoleID") FROM role),1));
SELECT setval(pg_get_serial_sequence('role_permission','RolePermissionID'), COALESCE((SELECT MAX("RolePermissionID") FROM role_permission),1));
SELECT setval(pg_get_serial_sequence('session','SessionID'), COALESCE((SELECT MAX("SessionID") FROM session),1));
SELECT setval(pg_get_serial_sequence('student','StudentID'), COALESCE((SELECT MAX("StudentID") FROM student),1));
SELECT setval(pg_get_serial_sequence('student_guardian','StudentGuardianID'), COALESCE((SELECT MAX("StudentGuardianID") FROM student_guardian),1));
SELECT setval(pg_get_serial_sequence('student_observation','ObservationID'), COALESCE((SELECT MAX("ObservationID") FROM student_observation),1));
SELECT setval(pg_get_serial_sequence('student_payment','StudentPaymentID'), COALESCE((SELECT MAX("StudentPaymentID") FROM student_payment),1));
SELECT setval(pg_get_serial_sequence('teacher_payment','TeacherPaymentID'), COALESCE((SELECT MAX("TeacherPaymentID") FROM teacher_payment),1));
SELECT setval(pg_get_serial_sequence('"user"','UserID'), COALESCE((SELECT MAX("UserID") FROM "user"),1));
SELECT setval(pg_get_serial_sequence('user_role','UserRoleID'), COALESCE((SELECT MAX("UserRoleID") FROM user_role),1));
